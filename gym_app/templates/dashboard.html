{% extends 'base.html' %}

{% block title %}Dashboard - Groei App{% endblock %}

{% block content %}
<div class="dashboard-container">
    <header class="dashboard-header">
        <h1>Your Dashboard</h1>
        <a href="{{ url_for('workout.new_workout') }}" class="btn btn-primary">
            <i class="fas fa-plus-circle"></i> New Workout
        </a>
    </header>

    <!-- Stat Cards -->
    <div class="stat-cards">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stat-content">
                <h3 class="stat-value">{{ monthly_workouts }}</h3>
                <p class="stat-label">Monthly Workouts</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-fire-alt"></i>
            </div>
            <div class="stat-content">
                <h3 class="stat-value">{{ streak }}</h3>
                <p class="stat-label">Day Streak</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-dumbbell"></i>
            </div>
            <div class="stat-content">
                <h3 class="stat-value">{{ workouts|length }}</h3>
                <p class="stat-label">Total Workouts</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-medal"></i>
            </div>
            <div class="stat-content">
                <h3 class="stat-value">{{ favorite_exercise }}</h3>
                <p class="stat-label">Favorite Exercise</p>
            </div>
        </div>
    </div>

    <!-- Workout Activity Heatmap -->
    <section class="dashboard-section">
        <div class="section-header">
            <h2>Workout Activity</h2>
            <div class="heatmap-legend">
                <span>0 kg</span>
                <div class="heat-level-0 legend-box"></div>
                <div class="heat-level-1 legend-box"></div>
                <div class="heat-level-2 legend-box"></div>
                <div class="heat-level-3 legend-box"></div>
                <div class="heat-level-4 legend-box"></div>
                <span>10000+ kg</span>
            </div>
        </div>
        
        {% if workout_data %}
            <div class="heatmap-container">
                <div class="heatmap-grid">
                    <div id="workout-heatmap" class="calendar-heatmap" data-workout-dates='{{ workout_data|map(attribute="date")|list|tojson }}' data-workout-weights='{{ workout_data|map(attribute="total_weight")|list|tojson }}'></div>
                </div>
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-calendar-alt"></i>
                <p>No workout data available yet. Start working out to see your activity!</p>
            </div>
        {% endif %}
    </section>
    
    <!-- Recent Workouts -->
    <section class="dashboard-section">
        <div class="section-header">
            <h2>Recent Workouts</h2>
            {% if workouts|length > 6 %}
                <a href="#" class="section-link">View All</a>
            {% endif %}
        </div>
        
        {% if workouts %}
            <div class="recent-workouts-grid">
                {% for workout_item in workout_data[:6] %}
                    <div class="workout-card">
                        <div class="workout-header">
                            <h3>{{ workout_item.workout.name or 'Workout ' ~ loop.index }}</h3>
                            <span class="muscle-badge" data-muscle="{{ workout_item.primary_muscle_group|lower }}">
                                {{ workout_item.primary_muscle_group|capitalize }}
                            </span>
                        </div>
                        <div class="workout-details">
                            <div class="workout-date">
                                <i class="fas fa-calendar-day"></i>
                                {{ workout_item.workout.date.strftime('%B %d, %Y') }}
                            </div>
                            <div class="workout-weight">
                                <i class="fas fa-weight-hanging"></i>
                                {{ workout_item.total_weight|round|int }} kg total
                            </div>
                        </div>
                        <a href="{{ url_for('workout.session', workout_id=workout_item.workout.id) }}" class="workout-link">
                            View Details <i class="fas fa-angle-right"></i>
                        </a>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-dumbbell"></i>
                <p>No workouts recorded yet. Start your fitness journey today!</p>
                <a href="{{ url_for('workout.new_workout') }}" class="btn btn-primary">Start First Workout</a>
            </div>
        {% endif %}
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Generate clean workout activity heatmap
    document.addEventListener('DOMContentLoaded', function() {
        const heatmapEl = document.getElementById('workout-heatmap');
        if (!heatmapEl) return; // Exit if element doesn't exist
        
        // Get workout dates and weights from data attributes
        const workoutDates = JSON.parse(heatmapEl.getAttribute('data-workout-dates') || '[]');
        const workoutWeights = JSON.parse(heatmapEl.getAttribute('data-workout-weights') || '[]');
        
        // Create lookup object for date -> weight
        const dateWeightMap = {};
        for (let i = 0; i < workoutDates.length; i++) {
            dateWeightMap[workoutDates[i]] = workoutWeights[i];
        }
        
        // Create the current year calendar starting from January 1st
        const today = new Date();
        const currentYear = today.getFullYear();
        const startOfYear = new Date(currentYear, 0, 1); // January 1st of current year
        
        // Add month labels (properly positioned)
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const monthLabelContainer = document.createElement('div');
        monthLabelContainer.className = 'month-labels';
        
        // Create the month labels based on calculated positions
        for (let i = 0; i < 12; i++) {
            const monthStart = new Date(currentYear, i, 1);
            
            // Get the day of week for this month (0 = Sunday)
            const firstDayOfMonth = monthStart.getDay();
            
            // Calculate days since start of year
            const daysSinceStart = Math.floor((monthStart - startOfYear) / (1000 * 60 * 60 * 24));
            
            // Calculate the week column more precisely
            const weekOffset = Math.floor(daysSinceStart / 7);
            
            const monthLabel = document.createElement('div');
            monthLabel.className = 'month-label';
            monthLabel.textContent = months[i];
            monthLabel.style.gridColumn = weekOffset + 1; // 1-based for CSS grid
            monthLabelContainer.appendChild(monthLabel);
        }
        
        // Add month labels to the heatmap grid container for better positioning
        const heatmapContainer = heatmapEl.closest('.heatmap-container');
        heatmapContainer.insertBefore(monthLabelContainer, heatmapContainer.firstChild);
        
        // Add day of week labels
        const weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const weekdayLabelContainer = document.createElement('div');
        weekdayLabelContainer.className = 'weekday-labels';
        
        for (let i = 0; i < 7; i++) {
            const dayLabel = document.createElement('div');
            dayLabel.className = 'weekday-label';
            dayLabel.textContent = weekdays[i];
            weekdayLabelContainer.appendChild(dayLabel);
        }
        
        // Using the parent heatmap-grid for better alignment
        const heatmapGrid = heatmapEl.closest('.heatmap-grid');
        heatmapGrid.insertBefore(weekdayLabelContainer, heatmapEl);
        
        // Get the first Monday of the year or the first day of the year
        const firstDay = new Date(startOfYear);
        // If January 1 is not Monday (1), adjust to previous Monday
        const dayOfWeek = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
        if (dayOfWeek !== 1) { // If not Monday
            const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            firstDay.setDate(firstDay.getDate() - daysToSubtract);
        }
        
        // Calculate number of days to display (enough weeks to reach December)
        const weeksToShow = 53; // Maximum weeks in a year plus buffer
        const totalDays = weeksToShow * 7;
        
        // Create all cells for the entire grid
        for (let i = 0; i < totalDays; i++) {
            const cellDate = new Date(firstDay);
            cellDate.setDate(firstDay.getDate() + i);
            
            // Check if we're in the current year
            const isCurrentYear = cellDate.getFullYear() === currentYear;
            
            // Skip if we're beyond today or in the next year
            if (cellDate > today || !isCurrentYear) continue;
            
            // Map day 0-6 (Monday-Sunday)
            // In our grid: Monday=0, Sunday=6
            let row = (cellDate.getDay() + 6) % 7; // Convert Sunday=0 to Sunday=6
            
            // Calculate week column
            const weekNumber = getWeekNumber(cellDate) - getWeekNumber(firstDay);
            const col = weekNumber;
            
            // Format date as ISO string for lookup (YYYY-MM-DD)
            const dateStr = cellDate.toISOString().split('T')[0];
            
            // Determine intensity based on weight
            let intensity = 0;
            let weight = 0;
            
            if (dateStr in dateWeightMap) {
                weight = dateWeightMap[dateStr];
                // Set intensity level based on weight with higher threshold (up to 10000kg)
                if (weight > 0 && weight <= 1000) intensity = 1;
                else if (weight > 1000 && weight <= 3000) intensity = 2;
                else if (weight > 3000 && weight <= 10000) intensity = 3;
                else if (weight > 10000) intensity = 4;
            }
            
            // Create day element
            const dayEl = document.createElement('div');
            dayEl.className = `calendar-day heat-level-${intensity}`;
            dayEl.style.gridRow = row + 1; // 1-based for CSS grid (Monday first)
            dayEl.style.gridColumn = col + 1; // 1-based for CSS grid
            
            // Add tooltip with date and weight info
            let tooltipText = `${cellDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}`;
            if (weight > 0) {
                tooltipText += `: ${Math.round(weight)} kg`;
                
                // Add intensity label
                if (intensity === 1) tooltipText += " (Light)";
                else if (intensity === 2) tooltipText += " (Medium)";
                else if (intensity === 3) tooltipText += " (Heavy)";
                else if (intensity === 4) tooltipText += " (Intense)";
            } else {
                tooltipText += ": No workout";
            }
            dayEl.setAttribute('title', tooltipText);
            dayEl.setAttribute('data-date', dateStr);
            
            heatmapEl.appendChild(dayEl);
        }
        
        // Helper function to get week number
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }
    });
</script>

<style>
    /* Dashboard Layout */
    .dashboard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }
    
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .dashboard-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #1F2937;
        margin: 0;
    }
    
    /* Stat Cards */
    .stat-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2.5rem;
    }
    
    .stat-card {
        background-color: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        background-color: #EEF2FF;
        color: #4F46E5;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-right: 1rem;
    }
    
    .stat-content {
        flex: 1;
    }
    
    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1F2937;
        margin: 0 0 0.25rem 0;
    }
    
    .stat-label {
        color: #6B7280;
        font-size: 0.875rem;
        margin: 0;
    }
    
    /* Dashboard Sections */
    .dashboard-section {
        background-color: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .section-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1F2937;
        margin: 0;
    }
    
    .section-link {
        color: #4F46E5;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
    }
    
    .section-link:hover {
        text-decoration: underline;
    }
    
    /* Heatmap */
    .heatmap-container {
        position: relative;
        margin-top: 1rem;
        background-color: white;
        border-radius: 8px;
        padding: 1.5rem 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .heatmap-legend {
        display: flex;
        align-items: center;
        gap: 4px;
        margin-left: auto;
    }
    
    .heatmap-legend span {
        font-size: 0.75rem;
        color: #6B7280;
        font-weight: 500;
    }
    
    .legend-box {
        width: 12px;
        height: 12px;
        border-radius: 2px;
    }
    
    /* Better layout with proper positioning */
    .heatmap-grid {
        display: flex;
        margin-top: 24px; /* Give space for month labels */
        position: relative;
    }
    
    .weekday-labels {
        display: grid;
        grid-template-rows: repeat(7, 1fr);
        gap: 2px;
        height: 112px; /* Match the height of the heatmap (7 rows * 14px + 6 gap * 2px) */
        margin-right: 12px;
        position: relative;
        top: 0;
    }
    
    .weekday-label {
        font-size: 11px;
        color: #9CA3AF;
        display: flex;
        align-items: center;
        height: 14px;
        text-align: left;
        font-weight: 500;
    }
    
    .calendar-heatmap {
        display: grid;
        grid-template-columns: repeat(53, 1fr);
        grid-template-rows: repeat(7, 1fr);
        gap: 2px;
        margin: 0;
        flex: 1;
    }
    
    .month-labels {
        display: grid;
        grid-template-columns: repeat(53, 1fr);
        height: 20px;
        align-items: center;
        border-bottom: 1px solid #f3f4f6;
        padding-bottom: 4px;
        margin-bottom: 8px;
        position: absolute;
        top: -24px;
        left: 40px; /* Align with the calendar grid */
        right: 0;
    }
    
    .month-label {
        font-size: 11px;
        font-weight: 500;
        color: #6B7280;
        text-align: left;
    }
    
    .calendar-day {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        transition: transform 0.05s ease-out;
    }
    
    .calendar-day:hover {
        transform: scale(1.3);
        z-index: 10;
        transition: transform 0.03s ease-out;
    }
    
    .heat-level-0 {
        background-color: #ebedf0;
    }
    
    .heat-level-1 {
        background-color: #9be9a8;
    }
    
    .heat-level-2 {
        background-color: #40c463;
    }
    
    .heat-level-3 {
        background-color: #30a14e;
    }
    
    .heat-level-4 {
        background-color: #216e39;
    }
    
    /* Recent Workouts */
    .recent-workouts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
    }
    
    .workout-card {
        border: 1px solid #E5E7EB;
        border-radius: 0.5rem;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .workout-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .workout-header {
        background-color: #F9FAFB;
        padding: 1rem;
        border-bottom: 1px solid #E5E7EB;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .workout-header h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #1F2937;
        margin: 0;
    }
    
    .muscle-badge {
        background-color: #4F46E5;
        color: white;
        font-size: 0.6875rem;
        font-weight: 500;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
    }
    
    /* Muscle group color coding */
    .muscle-badge[data-muscle="chest"] {
        background-color: #4F46E5;
    }
    
    .muscle-badge[data-muscle="back"] {
        background-color: #0EA5E9;
    }
    
    .muscle-badge[data-muscle="legs"] {
        background-color: #10B981;
    }
    
    .muscle-badge[data-muscle="shoulders"] {
        background-color: #F59E0B;
    }
    
    .muscle-badge[data-muscle="arms"] {
        background-color: #EF4444;
    }
    
    .muscle-badge[data-muscle="abs"] {
        background-color: #8B5CF6;
    }
    
    .workout-details {
        padding: 1rem;
    }
    
    .workout-date, .workout-weight {
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        color: #6B7280;
        margin-bottom: 0.5rem;
    }
    
    .workout-date i, .workout-weight i {
        width: 16px;
        margin-right: 0.5rem;
        text-align: center;
    }
    
    .workout-link {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: #F9FAFB;
        padding: 0.75rem 1rem;
        color: #4F46E5;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        border-top: 1px solid #E5E7EB;
    }
    
    .workout-link:hover {
        background-color: #F3F4F6;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6B7280;
    }
    
    .empty-state i {
        font-size: 2.5rem;
        color: #E5E7EB;
        margin-bottom: 1rem;
    }
    
    .empty-state p {
        margin-bottom: 1.5rem;
    }
    
    @media (max-width: 768px) {
        .workout-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .muscle-badge {
            margin-top: 0.5rem;
        }
        
        .weekday-labels {
            display: none;
        }
    }
</style>
{% endblock %}

{% extends 'base.html' %}

{% block title %}Dashboard - Groei App{% endblock %}

{% block content %}
<div class="dashboard container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8">Your Dashboard</h1>
    
    <div class="stats-container grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
        <div class="stat-card bg-white rounded-lg p-6 shadow">
            <div class="stat-icon text-indigo-600 mb-4">
                <i class="fas fa-calendar-check text-3xl"></i>
            </div>
            <h3 class="stat-label text-gray-600 text-lg">Monthly Workouts</h3>
            <p class="stat-value text-3xl font-bold">{{ monthly_workouts }}</p>
        </div>
        
        <div class="stat-card bg-white rounded-lg p-6 shadow">
            <div class="stat-icon text-indigo-600 mb-4">
                <i class="fas fa-fire-alt text-3xl"></i>
            </div>
            <h3 class="stat-label text-gray-600 text-lg">Current Streak</h3>
            <p class="stat-value text-3xl font-bold">{{ streak }} days</p>
        </div>
        
        <div class="stat-card bg-white rounded-lg p-6 shadow">
            <div class="stat-icon text-indigo-600 mb-4">
                <i class="fas fa-dumbbell text-3xl"></i>
            </div>
            <h3 class="stat-label text-gray-600 text-lg">Total Workouts</h3>
            <p class="stat-value text-3xl font-bold">{{ workouts|length }}</p>
        </div>
    </div>
    
    <div class="annual-activity mb-12">
        <div class="section-header flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Workout Activity</h2>
            <div class="intensity-legend flex items-center">
                <span class="text-sm mr-2">Less</span>
                <div class="heat-level-0 legend-box"></div>
                <div class="heat-level-1 legend-box"></div>
                <div class="heat-level-2 legend-box"></div>
                <div class="heat-level-3 legend-box"></div>
                <div class="heat-level-4 legend-box"></div>
                <span class="text-sm ml-2">More</span>
            </div>
        </div>
        
        {% if workout_data %}
            <div id="workout-heatmap" class="calendar-heatmap" data-workout-dates='{{ workout_data|map(attribute="date")|list|tojson }}' data-workout-weights='{{ workout_data|map(attribute="total_weight")|list|tojson }}'></div>
        {% else %}
            <p class="text-gray-500 italic">No workout data available yet. Start working out to see your activity!</p>
        {% endif %}
    </div>
    
    <div class="recent-workouts">
        <h2 class="text-2xl font-bold mb-4">Recent Workouts</h2>
        
        {% if workouts %}
            <div class="workouts-list grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for workout_item in workout_data[:6] %}
                    <div class="workout-card bg-white rounded-lg p-6 shadow hover:shadow-md transition-shadow">
                        <div class="flex justify-between mb-3">
                            <h3 class="text-xl font-semibold">{{ workout_item.workout.name or 'Workout ' ~ loop.index }}</h3>
                            <span class="pill bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-medium">{{ workout_item.primary_muscle_group|capitalize }}</span>
                        </div>
                        <div class="mb-2 text-gray-600">
                            <i class="fas fa-calendar-day mr-2"></i>{{ workout_item.workout.date.strftime('%B %d, %Y') }}
                        </div>
                        <div class="mb-3 text-gray-600">
                            <i class="fas fa-weight-hanging mr-2"></i>{{ workout_item.total_weight|round|int }} kg total
                        </div>
                        <a href="{{ url_for('workout.session', workout_id=workout_item.workout.id) }}" class="btn btn-sm btn-outline block text-center w-full">
                            View Details
                        </a>
                    </div>
                {% endfor %}
            </div>
            
            {% if workouts|length > 6 %}
                <div class="text-center mt-6">
                    <a href="#" class="btn btn-outline">View All Workouts</a>
                </div>
            {% endif %}
        {% else %}
            <p class="text-gray-500 italic">No workouts recorded yet. Start your fitness journey today!</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Generate GitHub-style workout heatmap
    document.addEventListener('DOMContentLoaded', function() {
        const heatmapEl = document.getElementById('workout-heatmap');
        if (!heatmapEl) return; // Exit if element doesn't exist
        
        // Get workout dates and weights from data attributes
        const workoutDates = JSON.parse(heatmapEl.getAttribute('data-workout-dates') || '[]');
        const workoutWeights = JSON.parse(heatmapEl.getAttribute('data-workout-weights') || '[]');
        
        // Create lookup object for date -> weight
        const dateWeightMap = {};
        for (let i = 0; i < workoutDates.length; i++) {
            dateWeightMap[workoutDates[i]] = workoutWeights[i];
        }
        
        // Create a year of calendar days
        const today = new Date();
        const oneYearAgo = new Date();
        oneYearAgo.setFullYear(today.getFullYear() - 1);
        
        // Get day of week for oneYearAgo to align grid
        const startDayOfWeek = oneYearAgo.getDay();
        
        // Add day labels (Sun, Mon, etc.)
        const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const dayLabelContainer = document.createElement('div');
        dayLabelContainer.className = 'day-labels';
        
        // Empty first cell for alignment with month labels
        const emptyLabel = document.createElement('div');
        emptyLabel.className = 'day-label empty';
        dayLabelContainer.appendChild(emptyLabel);
        
        for (let i = 0; i < 7; i++) {
            const dayLabel = document.createElement('div');
            dayLabel.className = 'day-label';
            dayLabel.textContent = dayLabels[i];
            dayLabelContainer.appendChild(dayLabel);
        }
        
        heatmapEl.parentNode.insertBefore(dayLabelContainer, heatmapEl);
        
        // Add month labels
        const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const monthLabelContainer = document.createElement('div');
        monthLabelContainer.className = 'month-labels';
        
        for (let i = 0; i < 12; i++) {
            const monthLabel = document.createElement('div');
            monthLabel.className = 'month-label';
            monthLabel.textContent = monthLabels[i];
            monthLabelContainer.appendChild(monthLabel);
        }
        
        heatmapEl.parentNode.insertBefore(monthLabelContainer, heatmapEl);
        
        // Add empty cells for alignment (if needed)
        for (let i = 0; i < startDayOfWeek; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day';
            emptyDay.style.visibility = 'hidden';
            heatmapEl.appendChild(emptyDay);
        }
        
        // Create all days for the past year
        for (let d = 0; d < 365; d++) {
            const date = new Date(oneYearAgo);
            date.setDate(oneYearAgo.getDate() + d);
            
            // Format date as ISO string for lookup (YYYY-MM-DD)
            const dateStr = date.toISOString().split('T')[0];
            
            // Determine intensity based on weight
            let intensity = 0;
            let weight = dateWeightMap[dateStr] || 0;
            
            // Set intensity level based on weight
            if (weight > 0 && weight <= 500) intensity = 1;
            else if (weight > 500 && weight <= 1000) intensity = 2;
            else if (weight > 1000 && weight <= 2000) intensity = 3;
            else if (weight > 2000) intensity = 4;
            
            // Create day element
            const dayEl = document.createElement('div');
            dayEl.className = `calendar-day heat-level-${intensity}`;
            dayEl.setAttribute('data-date', dateStr);
            
            // Add tooltip with date and weight info
            let tooltipText = `${date.toLocaleDateString()}`;
            if (weight > 0) {
                tooltipText += `: ${Math.round(weight)} kg`;
                
                // Add intensity label
                if (intensity === 1) tooltipText += " (Light)";
                else if (intensity === 2) tooltipText += " (Medium)";
                else if (intensity === 3) tooltipText += " (Heavy)";
                else if (intensity === 4) tooltipText += " (Intense)";
            } else {
                tooltipText += ": No workout";
            }
            
            dayEl.setAttribute('title', tooltipText);
            heatmapEl.appendChild(dayEl);
        }
    });
</script>

<style>
    .calendar-heatmap {
        display: grid;
        grid-template-columns: repeat(53, 1fr);
        grid-template-rows: repeat(7, 1fr);
        gap: 3px;
        margin-top: 20px;
    }
    
    .day-labels {
        display: grid;
        grid-template-columns: 30px repeat(7, 1fr);
        margin-bottom: 8px;
    }
    
    .day-label {
        font-size: 12px;
        color: #718096;
        text-align: center;
    }
    
    .month-labels {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        margin-bottom: 8px;
    }
    
    .month-label {
        font-size: 12px;
        color: #718096;
        text-align: left;
    }
    
    .calendar-day {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        cursor: pointer;
    }
    
    .heat-level-0 {
        background-color: #ebedf0;
    }
    
    .heat-level-1 {
        background-color: #c6e48b;
    }
    
    .heat-level-2 {
        background-color: #7bc96f;
    }
    
    .heat-level-3 {
        background-color: #239a3b;
    }
    
    .heat-level-4 {
        background-color: #196127;
    }
    
    .legend-box {
        width: 12px;
        height: 12px;
        margin: 0 2px;
        border-radius: 2px;
    }
    
    .pill {
        border-radius: 9999px;
        padding: 4px 12px;
        font-size: 12px;
        font-weight: 500;
    }
</style>
{% endblock %}
